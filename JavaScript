const API_URL = 'http://localhost:8080/api';

// --- Auth ---
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user'));
    const authLinks = document.getElementById('auth-links');
    const userLinks = document.getElementById('user-links');

    if (user) {
        if (authLinks) authLinks.classList.add('hidden');
        if (userLinks) userLinks.classList.remove('hidden');
    } else {
        if (window.location.pathname.includes('cart.html')) {
            window.location.href = 'login.html';
        }
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const res = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (res.ok) {
            const user = await res.json();
            localStorage.setItem('user', JSON.stringify(user));
            window.location.href = 'index.html';
        } else {
            alert('Invalid credentials');
        }
    } catch (err) {
        console.error(err);
        alert('Login failed');
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const res = await fetch(`${API_URL}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password })
        });

        if (res.ok) {
            alert('Registration successful! Please login.');
            window.location.href = 'login.html';
        } else {
            alert('Registration failed');
        }
    } catch (err) {
        console.error(err);
        alert('Registration failed');
    }
}

function logout() {
    localStorage.removeItem('user');
    window.location.href = 'login.html';
}

// --- Products ---
async function loadProducts() {
    try {
        const res = await fetch(`${API_URL}/products`);
        const products = await res.json();
        renderProducts(products);
    } catch (err) {
        console.error(err);
    }
}

async function searchProducts() {
    const keyword = document.getElementById('search-input').value.trim();

    if (!keyword) {
        loadProducts();
        return;
    }

    const grid = document.getElementById('product-grid');
    grid.innerHTML = '<div class="text-center" style="grid-column: 1/-1;">Searching...</div>';

    try {
        const res = await fetch(`${API_URL}/products/search?keyword=${keyword}`);
        const products = await res.json();
        renderProducts(products);
    } catch (err) {
        console.error(err);
        grid.innerHTML = '<div class="text-center" style="color:red; grid-column: 1/-1;">Error searching products. Ensure backend is running.</div>';
    }
}

function clearSearch() {
    document.getElementById('search-input').value = '';
    loadProducts();
}

function renderProducts(products) {
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';

    if (products.length === 0) {
        grid.innerHTML = '<div class="text-center" style="grid-column: 1/-1;"><h3>No products found matching your search.</h3></div>';
        return;
    }

    products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <img src="${p.imageUrl}" alt="${p.name}">
            <h3>${p.name}</h3>
            <span class="price">$${p.price.toFixed(2)}</span>
            <button class="btn" onclick="addToCart(${p.id})">Add to Cart</button>
        `;
        grid.appendChild(card);
    });
}

// --- Cart ---
async function addToCart(productId) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login to add items to cart');
        window.location.href = 'login.html';
        return;
    }

    try {
        const res = await fetch(`${API_URL}/cart/add?userId=${user.id}&productId=${productId}&quantity=1`, {
            method: 'POST'
        });
        if (res.ok) {
            alert('Added to cart!');
            updateCartCount();
        }
    } catch (err) {
        console.error(err);
        alert('Failed to add to cart');
    }
}

async function updateCartCount() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return;

    try {
        const res = await fetch(`${API_URL}/cart/${user.id}`);
        const items = await res.json();
        const start = document.getElementById('cart-count');
        if (start) {
            const count = items.reduce((acc, item) => acc + item.quantity, 0);
            start.innerText = `(${count})`;
        }
    } catch (err) {
        console.error(err);
    }
}

async function loadCart() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return;

    try {
        const res = await fetch(`${API_URL}/cart/${user.id}`);
        const items = await res.json();
        renderCart(items);
    } catch (err) {
        console.error(err);
    }
}

function renderCart(items) {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    let total = 0;

    if (items.length === 0) {
        container.innerHTML = '<p>Your cart is empty.</p>';
        document.getElementById('cart-total').innerText = '0.00';
        return;
    }

    items.forEach(item => {
        total += item.product.price * item.quantity;
        const div = document.createElement('div');
        div.className = 'card';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:1rem;">
                <img src="${item.product.imageUrl}" style="width:50px; height:50px; object-fit:cover;">
                <div>
                    <h3>${item.product.name}</h3>
                    <p>Qty: ${item.quantity} x $${item.product.price}</p>
                </div>
            </div>
            <div>
                <span class="price">$${(item.product.price * item.quantity).toFixed(2)}</span>
                <button class="btn btn-danger" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;
        container.appendChild(div);
    });

    document.getElementById('cart-total').innerText = total.toFixed(2);
}

async function removeFromCart(cartItemId) {
    try {
        await fetch(`${API_URL}/cart/remove/${cartItemId}`, { method: 'DELETE' });
        loadCart();
        updateCartCount();
    } catch (err) {
        console.error(err);
    }
}

async function placeOrder() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return;

    if (!confirm('Confirm place order?')) return;

    try {
        const res = await fetch(`${API_URL}/orders/place/${user.id}`, { method: 'POST' });
        if (res.ok) {
            alert('Order placed successfully!');
            window.location.href = 'index.html';
        } else {
            alert('Failed to place order (Cart might be empty)');
        }
    } catch (err) {
        console.error(err);
        alert('Error placing order');
    }
}
